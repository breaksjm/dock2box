{{define "host"}}{{template "docker" .}}
{{if get (print "/hwaddr/" .vars.hwaddr)}}{{template "registered" .}}{{else}}{{template "unregistered" .}}{{end}}
{{end}}

{{define "unregistered"}}
{{$g := get (print "/global")}}
{{$b := get (print "/image/" $g.bootstrap_image)}}
{{$subnet := getsubnet (index .params.ipv4 0) (index .params.netmask 0)}}
set menu-timeout 50000
set submenu-timeout 10000
#set menu-default {{$g.image}}
#set submenu-default {{$g.version}}
#set menu-default localdisk
set menu-default cobbler
set submenu-default latest
set server localhost
set boot-image {{$g.bootstrap_image}}
set boot-version {{$g.bootstrap_version}}
set boot-kopts {{$b.kopts}}

{{$shortname := replace ":" "" .vars.hwaddr}}
{{$hostname := print $shortname "." $g.domain}}
{{$ipv4 := index .params.ipv4 0}}
{{$netmask := index .params.netmask 0}}
{{$gateway := index .params.gateway 0}}
{{$hwaddr := .vars.hwaddr}}

{{$site := "none"}}
{{$file_uri := $g.file_uri}}
{{$registry := $g.registry}}

{{$s := get (print "/subnets/" (replace "/" "-" $subnet))}}
{{if $s}}
{{$si := get (print "/sites/" $s.site)}}
{{$site := $s.site}}
{{$file_uri := $si.file_uri}}
{{$registry := $si.registry}}
{{end}}

:start
imgfree

#menu dock2box
menu
item --gap -- {{center 65 "-" " Unregistered "}}
item --gap -- hostname: {{$hostname}}
item --gap -- subnet: {{$subnet}} site: {{$site}}
item --gap -- file_uri: {{$file_uri}}
item --gap -- registry: {{$registry}}
item --gap -- {{center 65 "-" " Info "}}
item --gap -- ipv4: {{$ipv4}} netmask: {{$netmask}}
item --gap -- gateway: {{$gateway}} hwaddr: {{$hwaddr}}
item --gap -- {{center 65 "-" " Menu "}}
item localdisk Boot from local disk
item cobbler Cobbler
item dock2box dock2box
item dock2box-dev dock2box-dev
item --gap -- {{center 65 "-" " Images "}}

{{$images := get "/image"}}
{{range $image, $e := $images}}item {{$image}} {{$image}}
{{end}}choose --default ${menu-default} --timeout ${menu-timeout} selected
goto ${selected}

:localdisk
sanboot --no-describe --drive 0x80

:cobbler
chain tftp://cobbler/undionly.kpxe

:dock2box
chain tftp://dock2box/undionly.kpxe

:dock2box-dev
chain tftp://dock2box-dev/undionly.kpxe

{{range $image, $e := $images}}:{{$image}}
#menu dock2box
menu
item --gap -- Image: {{$image}}
item --gap -- {{center 65 "-" " Versions "}}
item --key 0x08 back .. (top menu)
{{range $version, $e2 := $e.versions}}item {{$image}}-{{$version}} {{$version}} ({{$e2.timestamp}})
{{end}}choose --default ${menu-default}-${submenu-default} --timeout ${menu-timeout} selected
goto ${selected}
:back
goto start

{{range $version, $e2 := $e.versions}}:{{$image}}-{{$version}}
kernel {{$e.file_registry}}/${boot-image}-${boot-version}/kernel BOOTIF={{$.vars.hwaddr}} IP=None NETMASK={{index $.params.netmask 0}} GATEWAY={{index $.params.gateway 0}} ${boot-kopts} image_type={{$e.type}} image_name={{$image}} image_version={{$version}} hostname={{$hostname}} file_uri={{$file_uri}} registry={{$registry}}
initrd {{$e.file_registry}}/${boot-image}-${boot-version}/initrd
boot
{{end}}{{end}}{{end}}

{{define "registered"}}
{{$g := get (print "/global")}}
{{$b := get (print "/image/" $g.bootstrap_image)}}
{{$hw := get (print "/hwaddr/" .vars.hwaddr)}}
{{$h := get (print "/host/" $hw.hostname)}}
{{$subnet := getsubnet (index .params.ipv4 0) (index .params.netmask 0)}}
set menu-timeout 10000
set submenu-timeout 10000
set menu-default {{$g.image}}
set submenu-default {{$g.version}}
set server localhost
set boot-image {{$g.bootstrap_image}}
set boot-version {{$g.bootstrap_version}}
set boot-kopts {{$b.kopts}}

{{$site := "none"}}
{{$file_uri := $g.file_uri}}
{{$registry := $g.registry}}

{{$s := get (print "/subnets/" (replace "/" "-" $subnet))}}
{{if $s}}
{{$si := get (print "/sites/" $s.site)}}
{{$site := $s.site}}
{{$file_uri := $si.file_uri}}
{{$registry := $si.registry}}
{{end}}

:start
imgfree

#menu dock2box
menu
item --gap -- {{center 65 "-" " Registered "}}
item --gap -- hostname: {{$hw.hostname}}
item --gap -- build: {{$h.build}} debug: {{$h.debug}}
item --gap -- ipv4: {{$h.interface.default.ip}} netmask: {{$h.interface.default.netmask}}
item --gap -- gateway: {{$h.interface.default.gw}} hwaddr: {{$h.interface.default.hwaddr}}
item --gap -- subnet: {{$subnet}} site: {{$site}}
item --gap -- file_uri: {{$file_uri}}
item --gap -- registry: {{$registry}}
item --gap -- {{center 65 "-" " Info "}}
item --gap -- ipv4: {{index .params.ipv4 0}} netmask: {{index .params.netmask 0}}
item --gap -- gateway: {{index .params.gateway 0}} hwaddr: {{.vars.hwaddr}}
item --gap -- subnet: {{$subnet}}
item --gap -- {{center 65 "-" " Menu "}}
item localdisk Boot from local disk
item cobbler Cobbler
item --gap -- {{center 65 "-" " Images "}}
{{$images := get "/image"}}
{{range $image, $e := $images}}item {{$image}} {{$image}}
{{end}}choose --default ${menu-default} --timeout ${menu-timeout} selected
goto ${selected}

:localdisk
sanboot --no-describe --drive 0x80

:cobbler
chain tftp://cobbler/undionly.kpxe

{{range $image, $e := $images}}:{{$image}}
#menu dock2box
menu
item --gap -- Image: {{ $image }}
item --gap -- {{center 65 "-" " Versions "}}
item --key 0x08 back .. (top menu)
{{range $version, $e2 := $e.versions}}item {{$image}}-{{$version}} {{$version}} ({{$e2.timestamp}})
{{end}}choose --default ${menu-default}-${submenu-default} --timeout ${menu-timeout} selected
goto ${selected}
:back
goto start

{{range $version, $e2 := $e.versions}}:{{$image}}-{{$version}}
kernel {{$e.file_registry}}/${boot-image}-${boot-version}/kernel BOOTIF={{$.vars.hwaddr}} IP=None NETMASK={{index $.params.netmask 0}} GATEWAY={{index $.params.gateway 0}} ${boot-kopts} image_type={{$e.type}} image_name={{$image}} image_version={{$version}}
initrd {{$e.file_registry}}/${boot-image}-${boot-version}/initrd
boot
{{end}}{{end}}{{end}}
